.TH WATCHDOG 8 "February 1996"
.UC 4
.SH NAME
watchdog \- a software watchdog daemon
.SH SYNOPSIS
.B watchdog
[
.I -i interval
] [
.I -f
] [
.I -n file-name
] [
.I -l max load avg
] [
.I -m max temperature
] [
.I -p ip-addr
] [
.I -v
] [
.I -s
] [
.I -b
] [
.I -d watchdog-device
] [
.I -t temperature-device
] [
.I -c check-binary
] [
.I -r repair-binary
] [
.I -a admin
]
.br
.SH DESCRIPTION
Watchdog is a daemon that checks if your system is still working. If
programs in user space are not longer executed it will hard reset the system.

The kernel provides /dev/watchdog, which when open must be written
to within a minute or the machine will reboot. Each write delays the reboot
time another minute. After a minute the watchdog hardware will cause the
reset. In the case of the software watchdog the ability to 
reboot will depend on the state of the machines and interrupts.

Watchdog can be stopped without causing a reboot if the device /dev/watchdog
is closed correctly, unless of course your kernel is compiled with the
CONFIG_WATCHDOG_NOWAYOUT option enabled.
.LP
.SH TESTS
Watchdog itself does several additional tests to check the system status:
.TP
Check whether the process table is full.
.TP
Check whether a given file is accessible.
.TP
Check whether the average work load exceeds a predefined maximal value.
.TP
Check whether the a file table overflow occurred.
.TP
Check whether a given IP address answer to a ping message.
.TP
Check the temperature (if available).
.TP
Execute a user defined binary to do arbitrary tests.
.LP
If any of these checks fail watchdog will cause a shutdown. Should any of
these tests last longer than one minute the machine will be rebooted, too.
.LP
.SH OPTIONS
Available command line options are the following:
.TP
-i interval
Set the interval between two writes to the softdog device. The kernel
drivers expects a write command every minute. Otherwise the system will be
rebooted. Default value is 10 seconds. An interval of more than a minute can
only be used with the -f option.
.TP
-l max load avg
Set the maximal allowed load average. Once this load average is reached the
system is rebooted. Default value is 12. Be careful not to this parameter
too low. To set a value less then the predefined minimal value of 2, you
have to use the -f option.

Note that this option sets the maximal 1 minute load average. the five resp.
fifteen minutes average is derived from this as 3/4 resp. 1/2 of it.
.TP
-m max temperature
Set the maximal allowed temperature. Once this temperature is reached the
system is halted. Default value is 120. There is no unit conversion. So make
sure you use the same unit as your hardware. Watchdog will issue warnings
once the tempearture increases 90%, 95% and 98% of this temperature.
.TP
-f
Force the usage of the interval given with -i or the maximal load average
given with -l.
.TP
-d watchdog-device
Set the watchdog device name. Default is disable keep alive suppport.
.TP
-t temperature-device
Set the temperature device name. Default is disable temperature checking.
.TP
-n file-name
Set file name for file mode. Before sleeping <interval> seconds watchdog
tries to stat file <file-name>. An error returned by stat will
.I not 
cause a reboot. For a reboot the stat call has to last at least one
minute. This may happen if <file-name> is located on an NFS mounted
filesystem. If your system relies on an NFS mounted filesystem you might try
this option. However, in such a case the sync option may not work if the NFS
server is not answering.
.TP
-p ip-addr
Set IP address for ping mode. Before sleeping <interval> seconds watchdog
tries to ping the given address. This address does not have to be a single
machine. It is possible to ping to a broadcast address instead to see if at
least one machine in a subnet is still living. Watchdog will send out three
ping packages and wait up to <interval> seconds for the reply. Thus a
unreachable network will not cause a hard reset but a soft reboot.
.TP
-v
Set verbose mode. Only implemented if compiled with SYSLOG feature. This
mode will log each several infos in LOG_DAEMON with priority LOG_INFO.
This is useful if you want to see exactly what happened until watchdog rebooted
the system. Currently it logs the temperature (if available), the load
average and how often it went to sleep.
.TP
-s
Try to sync the filesystem every time the process is awake. Be aware that
the system is rebooted if for any reason syncing lasts longer than a minute.
.TP
-b
Soft-boot the system if an error occurs during the main loop, e.g. if the
file given with option -n is not accessible via the stat call. Note that
this does not apply to the open calls to /dev/watchdog and /proc/loadavg
which are opened before the main loop starts.
.TP
-c check-binary
Execute the given binary to do some user defined tests.
.TP
-r repair-binary
Execute the given binary in case of a problem instead of shutting down the
system. If this binary is not able to fix the problem watchdog will still
cause a reboot afterwards.
.TP
-a admin
Email address to send admin mail to. That is, who shall be notified that the
machine is being halted.
.LP
.SH SOFT REBOOT
A soft reboot (i.e. controlled shutdown and reboot) is initiated for every
error that is found. Since there might be no more processes available,
watchdog does it all by himself. That means:
.TP
1) Kill all processes with SIGTERM.
.TP
2) After a short pause kill all remaining processes with SIGKILL.
.TP
3) Record a shutdown entry in wtmp.
.TP
4) Save the random seed from /dev/urandom. If the device is non-existant or
the filename to save to is empty this step is skipped.
.TP
5) Turn off accounting.
.TP
6) Turn off quota and swapp.
.TP
7) Unmount all partitions except the root partition.
.TP
8) Remount the root partition read-only.
.TP
9) Shut down all network interfaces.
.TP
10) Finally reboot.
.LP
.SH TEST BINARY
If the return code of the check binary is not zero watchdog
will assume an error and reboot the system. An positive exit code is
interpreted as an system error code (see errno.h for details). Negative
values are special to watchdog:
.TP
-1 reboot the system. This is not exactly an error message but a command to
watchdog. If the return code is -1 watchdog will not try to run a shutdown
script instead.
.TP
-2 max load average exceeded.
.TP
-3 the temperature inside is too high.
.TP
-4 /proc/loadavg contains no (or not enough) data.
.TP
-5 free for personal use
.TP
...
.SH Note:
the binary is executed between two writes to the watchdog device.
So make sure you update the device yourself if your binary needs longer than
one minute. There is no way to tell watchdog to do a hard reset other than
running for longer than one minute.
.LP
.SH REPAIR BINARY
The repair binary is started with one parameter: the error number that
caused watchdog in initiate the boot process. After trying to repair the
system the binary should exit with 0 if the system was successfully repaired
and thus there is no need to boot anymore. A return value not equal 0 tells
watchdog to reboot. The return code of the repair binary should be the error
number of the error causing watchdog to reboot.
.SH BUGS
None known so far.
.LP
.SH AUTHORS
The original code is an example written by Alan Cox
<alan@lxorguk.ukuu.org.uk>, the author of the kernel driver. All
additions were written by Michael Meskes <meskes@debian.org>. Johnie Ingram
<johnie@netgod.net> had the idea of testing the load average. He also took
over the Debian specific work. Dave Cinege <dcinege@psychosis.com> brought
up some hardware watchdog issues and helped testing this stuff.
.LP
.SH FILES
.nf
/dev/watchdog  The watchdog device
/var/run/watchdog.pid The PID of the running watchdog
.fi
